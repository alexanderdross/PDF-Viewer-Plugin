<?php

/**
 * @file
 * Primary module hooks for PDF Embed & SEO Optimize Premium module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function pdf_embed_seo_premium_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.pdf_embed_seo_premium':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('PDF Embed & SEO Optimize Premium adds advanced features to the base PDF Embed module.') . '</p>';
      $output .= '<h3>' . t('Premium Features') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Analytics Dashboard - Detailed view statistics and reports') . '</li>';
      $output .= '<li>' . t('Password Protection - Protect individual PDFs with passwords') . '</li>';
      $output .= '<li>' . t('Reading Progress - Remember and restore user reading position') . '</li>';
      $output .= '<li>' . t('CSV Export - Export analytics data for external analysis') . '</li>';
      $output .= '<li>' . t('Premium REST API - Additional API endpoints for integrations') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function pdf_embed_seo_premium_theme($existing, $type, $theme, $path) {
  return [
    'pdf_password_form' => [
      'variables' => [
        'pdf_document' => NULL,
        'form' => NULL,
      ],
      'template' => 'pdf-password-form',
    ],
    'pdf_analytics_dashboard' => [
      'variables' => [
        'total_views' => 0,
        'total_documents' => 0,
        'popular_documents' => [],
        'recent_views' => [],
        'period' => '30days',
      ],
      'template' => 'pdf-analytics-dashboard',
    ],
  ];
}

/**
 * Grace period in days after license expiration.
 */
define('PDF_EMBED_SEO_PREMIUM_GRACE_PERIOD_DAYS', 14);

/**
 * Check if the premium module is active (license is valid).
 *
 * Validates license status and expiration date.
 * If license is expired, premium features are disabled and
 * the module falls back to free version functionality.
 *
 * @return bool
 *   TRUE if premium is active and license is valid.
 */
function pdf_embed_seo_premium_is_active() {
  $config = \Drupal::config('pdf_embed_seo_premium.settings');
  $license_status = $config->get('license_status') ?? 'inactive';
  $license_expires = $config->get('license_expires');

  // If license was never activated, run in free mode.
  if ($license_status === 'inactive' || empty($license_status)) {
    return FALSE;
  }

  // If license is marked as invalid, run in free mode.
  if ($license_status === 'invalid') {
    return FALSE;
  }

  // Check expiration date if license was previously valid.
  if ($license_status === 'valid' && !empty($license_expires)) {
    $expires_timestamp = strtotime($license_expires);
    $current_timestamp = \Drupal::time()->getRequestTime();

    // Check if license has expired.
    if ($expires_timestamp < $current_timestamp) {
      // Check if within grace period.
      $grace_end = $expires_timestamp + (PDF_EMBED_SEO_PREMIUM_GRACE_PERIOD_DAYS * 86400);

      if ($current_timestamp > $grace_end) {
        // Grace period ended - mark as expired and disable premium.
        \Drupal::configFactory()
          ->getEditable('pdf_embed_seo_premium.settings')
          ->set('license_status', 'expired')
          ->save();
        return FALSE;
      }

      // Within grace period - allow premium but with warning.
      return TRUE;
    }
  }

  // License is expired (manually set or detected).
  if ($license_status === 'expired') {
    return FALSE;
  }

  return $license_status === 'valid';
}

/**
 * Get the current license status.
 *
 * @return string
 *   License status: 'valid', 'expired', 'invalid', 'inactive', or 'grace_period'.
 */
function pdf_embed_seo_premium_get_license_status() {
  $config = \Drupal::config('pdf_embed_seo_premium.settings');
  $license_status = $config->get('license_status') ?? 'inactive';
  $license_expires = $config->get('license_expires');

  // Check if in grace period.
  if ($license_status === 'valid' && !empty($license_expires)) {
    $expires_timestamp = strtotime($license_expires);
    $current_timestamp = \Drupal::time()->getRequestTime();

    if ($expires_timestamp < $current_timestamp) {
      $grace_end = $expires_timestamp + (PDF_EMBED_SEO_PREMIUM_GRACE_PERIOD_DAYS * 86400);
      if ($current_timestamp <= $grace_end) {
        return 'grace_period';
      }
    }
  }

  return $license_status;
}

/**
 * Get days remaining until license expires.
 *
 * @return int|null
 *   Days remaining or NULL if no expiration set.
 */
function pdf_embed_seo_premium_get_days_remaining() {
  $config = \Drupal::config('pdf_embed_seo_premium.settings');
  $license_expires = $config->get('license_expires');

  if (empty($license_expires)) {
    return NULL;
  }

  $expires_timestamp = strtotime($license_expires);
  $current_timestamp = \Drupal::time()->getRequestTime();
  $diff = $expires_timestamp - $current_timestamp;

  if ($diff <= 0) {
    return 0;
  }

  return (int) ceil($diff / 86400);
}

/**
 * Implements hook_pdf_embed_seo_api_settings_alter().
 */
function pdf_embed_seo_premium_pdf_embed_seo_api_settings_alter(array &$settings) {
  // Only report premium features if license is valid.
  $is_premium_active = pdf_embed_seo_premium_is_active();

  $settings['is_premium'] = $is_premium_active;
  $settings['license_status'] = pdf_embed_seo_premium_get_license_status();

  if ($is_premium_active) {
    $settings['premium_features'] = [
      'analytics' => TRUE,
      'password_protection' => TRUE,
      'reading_progress' => TRUE,
      'csv_export' => TRUE,
    ];
  }
  else {
    $settings['premium_features'] = [];
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for pdf_embed_seo_settings_form.
 */
function pdf_embed_seo_premium_form_pdf_embed_seo_settings_form_alter(&$form, &$form_state, $form_id) {
  // Add premium settings section.
  $config = \Drupal::config('pdf_embed_seo_premium.settings');

  $form['premium'] = [
    '#type' => 'details',
    '#title' => t('Premium Features'),
    '#open' => TRUE,
    '#weight' => 50,
  ];

  $form['premium']['enable_analytics'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable Analytics Tracking'),
    '#description' => t('Track detailed view statistics in a separate database table.'),
    '#default_value' => $config->get('enable_analytics') ?? TRUE,
  ];

  $form['premium']['enable_password_protection'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable Password Protection'),
    '#description' => t('Allow individual PDFs to be password protected.'),
    '#default_value' => $config->get('enable_password_protection') ?? TRUE,
  ];

  $form['premium']['enable_reading_progress'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable Reading Progress'),
    '#description' => t('Remember and restore user reading position in PDFs.'),
    '#default_value' => $config->get('enable_reading_progress') ?? TRUE,
  ];

  $form['premium']['analytics_retention_days'] = [
    '#type' => 'number',
    '#title' => t('Analytics Data Retention (days)'),
    '#description' => t('Number of days to keep detailed analytics data. Set to 0 for unlimited.'),
    '#default_value' => $config->get('analytics_retention_days') ?? 365,
    '#min' => 0,
  ];

  // Add submit handler.
  $form['#submit'][] = 'pdf_embed_seo_premium_settings_form_submit';
}

/**
 * Submit handler for premium settings.
 */
function pdf_embed_seo_premium_settings_form_submit(&$form, &$form_state) {
  $config = \Drupal::configFactory()->getEditable('pdf_embed_seo_premium.settings');
  $config->set('enable_analytics', $form_state->getValue('enable_analytics'));
  $config->set('enable_password_protection', $form_state->getValue('enable_password_protection'));
  $config->set('enable_reading_progress', $form_state->getValue('enable_reading_progress'));
  $config->set('analytics_retention_days', $form_state->getValue('analytics_retention_days'));
  $config->save();
}
