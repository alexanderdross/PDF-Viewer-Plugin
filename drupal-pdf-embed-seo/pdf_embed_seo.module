<?php

/**
 * @file
 * Primary module hooks for PDF Embed & SEO Optimize module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Url;

/**
 * Implements hook_help().
 */
function pdf_embed_seo_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.pdf_embed_seo':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('PDF Embed & SEO Optimize integrates Mozilla PDF.js viewer to display PDFs with clean URLs and SEO optimization.') . '</p>';
      $output .= '<h3>' . t('Features') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Clean URL structure (e.g., /pdf/document-name/)') . '</li>';
      $output .= '<li>' . t('Mozilla PDF.js integration for secure PDF rendering') . '</li>';
      $output .= '<li>' . t('Print and download permission controls') . '</li>';
      $output .= '<li>' . t('SEO-optimized meta tags and Schema.org markup') . '</li>';
      $output .= '<li>' . t('View statistics tracking') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function pdf_embed_seo_theme($existing, $type, $theme, $path) {
  return [
    'pdf_document' => [
      'render element' => 'elements',
      'template' => 'pdf-document',
    ],
    'pdf_viewer' => [
      'variables' => [
        'pdf_document' => NULL,
        'pdf_url' => NULL,
        'allow_download' => FALSE,
        'allow_print' => FALSE,
        'viewer_theme' => 'light',
        'width' => '100%',
        'height' => '800px',
      ],
      'template' => 'pdf-viewer',
    ],
    'pdf_archive' => [
      'variables' => [
        'documents' => [],
        'pager' => NULL,
        'filters' => NULL,
        'display_style' => 'grid',
        'show_description' => TRUE,
        'show_view_count' => TRUE,
        'show_breadcrumbs' => TRUE,
        'archive_title' => 'PDF Documents',
        'archive_description' => '',
        'site_name' => '',
        'site_url' => '',
        'archive_url' => '',
      ],
      'template' => 'pdf-archive',
    ],
    'pdf_archive_item' => [
      'variables' => [
        'document' => NULL,
        'thumbnail' => NULL,
        'url' => NULL,
        'show_description' => TRUE,
        'show_view_count' => TRUE,
      ],
      'template' => 'pdf-archive-item',
    ],
  ];
}

/**
 * Implements hook_entity_extra_field_info().
 */
function pdf_embed_seo_entity_extra_field_info() {
  $extra = [];

  $extra['pdf_document']['pdf_document']['display']['pdf_viewer'] = [
    'label' => t('PDF Viewer'),
    'description' => t('The embedded PDF.js viewer.'),
    'weight' => 0,
    'visible' => TRUE,
  ];

  $extra['pdf_document']['pdf_document']['display']['pdf_download_button'] = [
    'label' => t('Download Button'),
    'description' => t('Download button for the PDF (if enabled).'),
    'weight' => 10,
    'visible' => TRUE,
  ];

  $extra['pdf_document']['pdf_document']['display']['pdf_view_count'] = [
    'label' => t('View Count'),
    'description' => t('Number of times the PDF has been viewed.'),
    'weight' => 20,
    'visible' => FALSE,
  ];

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view() for pdf_document entities.
 */
function pdf_embed_seo_pdf_document_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  // Increment view count.
  if ($view_mode === 'full') {
    $view_count = $entity->get('view_count')->value ?? 0;
    $entity->set('view_count', $view_count + 1);
    $entity->save();

    // Track analytics if premium is enabled.
    if (\Drupal::moduleHandler()->moduleExists('pdf_embed_seo_premium')) {
      \Drupal::service('pdf_embed_seo.analytics_tracker')->trackView($entity);
    }
  }

  // Add PDF viewer pseudo-field.
  if ($display->getComponent('pdf_viewer')) {
    $config = \Drupal::config('pdf_embed_seo.settings');
    $file = $entity->get('pdf_file')->entity;

    if ($file) {
      $build['pdf_viewer'] = [
        '#theme' => 'pdf_viewer',
        '#pdf_document' => $entity,
        '#pdf_url' => Url::fromRoute('pdf_embed_seo.pdf_data', [
          'pdf_document' => $entity->id(),
        ])->toString(),
        '#allow_download' => $entity->get('allow_download')->value ?? $config->get('default_allow_download'),
        '#allow_print' => $entity->get('allow_print')->value ?? $config->get('default_allow_print'),
        '#viewer_theme' => $config->get('viewer_theme') ?? 'light',
        '#attached' => [
          'library' => [
            'pdf_embed_seo/viewer',
          ],
          'drupalSettings' => [
            'pdfEmbedSeo' => [
              'pdfUrl' => Url::fromRoute('pdf_embed_seo.pdf_data', [
                'pdf_document' => $entity->id(),
              ])->toString(),
              'allowDownload' => (bool) ($entity->get('allow_download')->value ?? $config->get('default_allow_download')),
              'allowPrint' => (bool) ($entity->get('allow_print')->value ?? $config->get('default_allow_print')),
            ],
          ],
        ],
      ];

      // Add dark theme library if configured.
      if ($config->get('viewer_theme') === 'dark') {
        $build['pdf_viewer']['#attached']['library'][] = 'pdf_embed_seo/viewer-dark';
      }
    }
  }

  // Add download button pseudo-field.
  if ($display->getComponent('pdf_download_button')) {
    $allow_download = $entity->get('allow_download')->value ?? \Drupal::config('pdf_embed_seo.settings')->get('default_allow_download');

    if ($allow_download) {
      $file = $entity->get('pdf_file')->entity;
      if ($file) {
        $build['pdf_download_button'] = [
          '#type' => 'link',
          '#title' => t('Download PDF'),
          '#url' => Url::fromUri($file->createFileUrl()),
          '#attributes' => [
            'class' => ['pdf-download-button', 'button'],
            'download' => $entity->label() . '.pdf',
          ],
        ];
      }
    }
  }

  // Add view count pseudo-field.
  if ($display->getComponent('pdf_view_count')) {
    $build['pdf_view_count'] = [
      '#markup' => '<span class="pdf-view-count">' . t('@count views', [
        '@count' => $entity->get('view_count')->value ?? 0,
      ]) . '</span>',
    ];
  }
}

/**
 * Implements hook_page_attachments().
 */
function pdf_embed_seo_page_attachments(array &$attachments) {
  $route_match = \Drupal::routeMatch();

  // Add Schema.org markup for PDF documents.
  // Skip if Metatag module handles schema (to avoid duplicates).
  if ($route_match->getRouteName() === 'entity.pdf_document.canonical') {
    // Check if Metatag module with Schema.org support is handling this.
    $metatag_schema_active = \Drupal::moduleHandler()->moduleExists('schema_metatag');
    if ($metatag_schema_active) {
      // Let Metatag handle schema output.
      return;
    }

    $pdf_document = $route_match->getParameter('pdf_document');

    if ($pdf_document) {
      $document_url = Url::fromRoute('entity.pdf_document.canonical', [
        'pdf_document' => $pdf_document->id(),
      ], ['absolute' => TRUE])->toString();
      $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

      $schema = [
        '@context' => 'https://schema.org',
        '@type' => 'DigitalDocument',
        '@id' => $document_url . '#digitaldocument',
        'name' => $pdf_document->label(),
        'url' => $document_url,
        'encodingFormat' => 'application/pdf',
        'datePublished' => date('c', $pdf_document->getCreatedTime()),
        'dateModified' => date('c', $pdf_document->getChangedTime()),
        'inLanguage' => $language,
      ];

      // Add description if available.
      $description = $pdf_document->get('description')->value ?? '';
      if (!empty($description)) {
        $schema['description'] = strip_tags($description);
      }

      // Add thumbnail if available.
      if ($pdf_document->hasField('thumbnail') && !$pdf_document->get('thumbnail')->isEmpty()) {
        $thumbnail = $pdf_document->get('thumbnail')->entity;
        if ($thumbnail) {
          $schema['thumbnailUrl'] = \Drupal::service('file_url_generator')->generateAbsoluteString($thumbnail->getFileUri());
        }
      }

      // Add author if available.
      if ($pdf_document->hasField('uid') && !$pdf_document->get('uid')->isEmpty()) {
        $author = $pdf_document->get('uid')->entity;
        if ($author) {
          $schema['author'] = [
            '@type' => 'Person',
            'name' => $author->getDisplayName(),
          ];
        }
      }

      // Add publisher (site).
      $site_name = \Drupal::config('system.site')->get('name');
      $schema['publisher'] = [
        '@type' => 'Organization',
        'name' => $site_name,
      ];

      // Allow other modules to alter the schema.
      \Drupal::moduleHandler()->alter('pdf_embed_seo_schema', $schema);

      $attachments['#attached']['html_head'][] = [
        [
          '#type' => 'html_tag',
          '#tag' => 'script',
          '#attributes' => ['type' => 'application/ld+json'],
          '#value' => json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE),
        ],
        'pdf_embed_seo_schema',
      ];
    }
  }

  // Add Schema.org markup for archive page.
  // Skip if Metatag module handles schema (to avoid duplicates).
  if ($route_match->getRouteName() === 'pdf_embed_seo.archive') {
    // Check if Metatag module with Schema.org support is handling this.
    $metatag_schema_active = \Drupal::moduleHandler()->moduleExists('schema_metatag');
    if ($metatag_schema_active) {
      // Let Metatag handle schema output.
      return;
    }

    $archive_url = Url::fromRoute('pdf_embed_seo.archive', [], ['absolute' => TRUE])->toString();
    $site_name = \Drupal::config('system.site')->get('name');
    $site_url = Url::fromRoute('<front>', [], ['absolute' => TRUE])->toString();
    $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

    $schema = [
      '@context' => 'https://schema.org',
      '@type' => 'CollectionPage',
      '@id' => $archive_url . '#collectionpage',
      'name' => t('PDF Documents'),
      'description' => t('Browse all available PDF documents.'),
      'url' => $archive_url,
      'inLanguage' => $language,
      'isPartOf' => [
        '@type' => 'WebSite',
        '@id' => $site_url . '#website',
        'name' => $site_name,
        'url' => $site_url,
      ],
      'mentions' => [
        [
          '@type' => 'Organization',
          'name' => 'Dross:Media',
          'url' => 'https://dross.net/media/',
        ],
        [
          '@type' => 'SoftwareApplication',
          'name' => 'WP & Drupal PDF Embed & SEO Optimize',
          'url' => 'https://pdfviewer.drossmedia.de',
        ],
      ],
    ];

    // Allow other modules to alter the schema.
    \Drupal::moduleHandler()->alter('pdf_embed_seo_schema', $schema);

    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#attributes' => ['type' => 'application/ld+json'],
        '#value' => json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE),
      ],
      'pdf_embed_seo_archive_schema',
    ];
  }
}

/**
 * Prepares variables for PDF document templates.
 *
 * Default template: pdf-document.html.twig.
 *
 * @param array $variables
 *   An associative array containing:
 *   - elements: An associative array containing the PDF document and any
 *     view mode specific elements.
 */
function template_preprocess_pdf_document(array &$variables) {
  $variables['pdf_document'] = $variables['elements']['#pdf_document'];
  $variables['view_mode'] = $variables['elements']['#view_mode'];

  // Helpful $content variable for templates.
  $variables['content'] = [];
  foreach (\Drupal\Core\Render\Element::children($variables['elements']) as $key) {
    $variables['content'][$key] = $variables['elements'][$key];
  }

  // Add show_breadcrumbs setting.
  $config = \Drupal::config('pdf_embed_seo.settings');
  $variables['show_breadcrumbs'] = $config->get('show_breadcrumbs') ?? TRUE;

  // Add site info for breadcrumbs.
  $variables['site_name'] = \Drupal::config('system.site')->get('name');
}

/**
 * Implements hook_preprocess_HOOK() for pdf_viewer.
 */
function template_preprocess_pdf_viewer(array &$variables) {
  $variables['attributes']['class'][] = 'pdf-viewer-container';
  $variables['attributes']['class'][] = 'pdf-viewer-theme-' . $variables['viewer_theme'];
  $variables['attributes']['data-pdf-url'] = $variables['pdf_url'];
  $variables['attributes']['data-allow-download'] = $variables['allow_download'] ? 'true' : 'false';
  $variables['attributes']['data-allow-print'] = $variables['allow_print'] ? 'true' : 'false';
}
